<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Stanovi</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            position: relative;
            z-index: 1;
            min-height: 100vh;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url(https://cdn.pixabay.com/photo/2020/04/21/18/49/tropical-5074304_960_720.jpg) no-repeat center center fixed;
            background-size: cover;
            opacity: 0.3;
            z-index: -1;
        }

        .main-container {
            display: flex;
            justify-content: center;
            max-width: 1000px;
            margin: 40px auto 0 auto;
            padding: 0 20px;
            box-sizing: border-box;
        }

        #sidebar {
            width: 100%;
            overflow-y: auto;
            background: #315276ad;
            padding: 20px;
            box-sizing: border-box;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        #notifications-panel {
            position: fixed;
            top: 40px;
            right: 20px;
            width: 350px;
            background: #315276ad;
            padding: 20px;
            box-sizing: border-box;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            height: fit-content;
            max-height: calc(100vh - 80px);
            overflow-y: auto;
            z-index: 1000;
        }

        @media (max-width: 1400px) {
            #notifications-panel {
                position: fixed;
                bottom: 20px;
                right: 20px;
                top: auto;
                width: 320px;
                max-height: 60vh;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                margin: 20px auto 0 auto;
                padding: 0 10px;
                max-width: 100%;
            }

            #notifications-panel {
                position: fixed;
                bottom: 10px;
                right: 10px;
                width: 280px;
                max-height: 50vh;
            }
        }

        #delete-btn {
            margin-left: 10px;
        }

        .entry {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            margin-top: 80px;
            margin-bottom: 80px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .entry.highlighted {
            border: 3px solid #dc3545 !important;
            background: #fff5f5 !important;
            box-shadow: 0 4px 16px rgba(220, 53, 69, 0.3) !important;
        }

        .date-separator {
            position: absolute;
            top: -58px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 37px;
            font-weight: bold;
            border-radius: 35px;
            z-index: 2;
        }

        .entry.new-entry {
            border: 3px solid #28a745;
            background: #f8fff9;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
        }

        .entry-row {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            align-items: center;
        }

        .entry-row input[type="text"] {
            flex: 1;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .rating-buttons {
            display: flex;
            gap: 7px;
            margin-left: 4px;
        }

        .rating-btn {
            width: 40px;
            height: 40px;
            padding: 0;
            font-size: 24px;
            font-weight: bold;
            background: transparent;
            border: none;
            color: #ddd;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .rating-btn:hover {
            color: #ffc107;
            transform: scale(1.1);
        }

        .rating-btn.selected {
            color: #ffc107;
        }

        .rating-btn.selected:hover {
            color: #ff9800;
        }

        .entry-row a {
            color: #007BFF;
            text-decoration: none;
            word-break: break-all;
            margin-right: 10px;
        }

        .entry-title-link {
            color: #007BFF;
            text-decoration: none;
            font-weight: bold;
            flex: 1;
            font-size: 18px;
            text-decoration: underline;
        }

        .entry-title-link:hover {
            text-decoration: underline;
        }

        textarea {
            width: 98%;
            resize: vertical;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: Arial, sans-serif;
            height: 70px;
        }

        button {
            background: #e5e5e5;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin: 2px;
        }

        button:hover {
            background: #9f9f9f;
        }



        h2 {
            margin: 0;
            display: inline-block;
            vertical-align: middle;
            color: #ffffff;
        }

        .header-buttons {
            margin-bottom: 20px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            height: 40px;
            position: relative;
        }

        .header-left {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
        }

        .header-right {
            flex: 1;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }



        .collapse-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f0f0f0;
            padding: 10px 15px;
            margin: -10px -10px 15px -10px;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            border-bottom: 1px solid #ddd;
        }

        .collapse-header h3 {
            margin: 0;
            color: #356e91;
            font-size: 20px;
        }

        .collapse-arrow {
            transition: transform 0.3s ease !important;
            font-size: 22px;
            display: inline-block;
        }

        .collapse-arrow.collapsed {
            transform: rotate(-90deg) !important;
        }

        .collapsible-content.collapsed {
            max-height: 0 !important;
        }

        .collapsible-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.collapsed {
            max-height: 0;
        }

        .person-box {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }

        .person-box.adis {}

        .person-box.roditelji {}

        .comment-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .comment-group {
            flex: 1;
            padding-top: 3px;
            margin-left: 6px;
        }

        .comment-label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
            font-size: 16px;
        }

        .comment-input {
            width: 95%;
            height: 180px;
            resize: vertical;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: Arial, sans-serif;
            font-size: 18px;
        }

        .comment-display {
            width: 95%;
            min-height: 60px;
            padding: 6px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            color: #555;
            font-size: 18px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .person-box.adis .comment-display {
            background-color: #edfff2;
        }

        .icon-button {
            font-size: 22px;
        }

        .delete-btn {
            color: #dc3545;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 3px;
            transition: background-color 0.2s ease;
            font-size: 40px;
            margin-top: -25px;
        }

        .delete-btn:hover {
            background-color: rgba(220, 53, 69, 0.1);
        }

        .star-filter-btn:hover {
            color: #ffc107 !important;
            transform: scale(1.1);
        }







        .maps-row {
            display: flex;
            gap: 10px;
        }

        .maps-row input {
            flex: 1;
        }

        .entry-links-row {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            align-items: center;
        }

        .instruction-text {
            font-size: 15px;
            color: #666;
            margin-bottom: 5px;
            font-style: italic;
        }

        .date-info {
            font-size: 15px;
            color: #666;
            margin-bottom: 8px;
            font-style: italic;
        }

        #status {
            font-size: 25px;
            color: #ffffff;
            padding: 7px;
            font-style: italic;
        }

        .loading {
            color: #666;
            font-style: italic;
        }

        .error {
            color: #dc3545;
            font-weight: bold;
        }

        .person-header {
            transition: all 0.3s ease;
            /* border-radius: 4px; */
            /* padding: 8px; */
            /* margin: -8px; */
            display: flex;
            align-items: center;
            gap: 15px;
            /* border: 2px solid #ddd; */
            /* border-radius: 8px; */
            /* padding: 15px; */

            /* margin-top: 12px; */
            /* background: #f8f9fa; */
        }

        .person-header:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            background-color: rgba(0, 123, 255, 0.05);
            transform: translateY(-1px);
        }

        #title {
            cursor: pointer;
            transition: color 0.3s ease;
        }

        #title:hover {
            color: #007bff;
        }

        .url-replacement-panel {
            display: none;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }

        .url-replacement-panel.show {
            display: block;
        }

        .replacement-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .replacement-input-group label {
            font-weight: bold;
            min-width: 80px;
            font-size: 14px;
        }

        .replacement-input-group input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }



        /* Notification popup styles */
        .ntfy-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 10001;
            max-width: 350px;
            animation: slideInRight 0.3s ease-out;
            cursor: pointer;
            border-left: 4px solid #4CAF50;
        }

        .ntfy-popup.error {
            border-left-color: #f44336;
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        }

        .ntfy-popup.warning {
            border-left-color: #ff9800;
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }

        .ntfy-popup .ntfy-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .ntfy-popup .ntfy-message {
            font-size: 14px;
            line-height: 1.4;
            white-space: pre-line;
        }

        .ntfy-popup .ntfy-close {
            position: absolute;
            top: 8px;
            right: 12px;
            cursor: pointer;
            font-size: 18px;
            opacity: 0.8;
        }

        .ntfy-popup .ntfy-close:hover {
            opacity: 1;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .ntfy-popup.hiding {
            animation: slideOutRight 0.3s ease-in forwards;
        }
    </style>
</head>

<body>
    <div class="main-container">
        <div id="sidebar">
            <div class="header-buttons">
                <div class="header-top">
                    <div class="header-left">
                        <div class="title-stats-container">
                            <h2 id="title">Stanovi</h2>
                            <span id="status" class="loading"
                                style="font-size: 16px; color: #ffffff; margin-left: -6px; display: block;">Učitava...</span>
                        </div>
                    </div>
                    <div class="header-center">
                        <div id="stats-info" style="font-size: 18px; color: #ffffff;"></div>
                    </div>
                    <div class="header-right">
                        <button id="update-btn"
                            style="background: #28a745; color: white; border: none; padding: 10px 21px; border-radius: 4px; font-size: 20px; cursor: pointer;"
                            onmouseover="this.style.backgroundColor='#218838'"
                            onmouseout="this.style.backgroundColor='#28a745'">Obnovi</button>
                    </div>
                </div>



                <!-- URL Replacement Panel -->
                <div id="url-replacement-panel" class="url-replacement-panel">
                    <div class="replacement-input-group">
                        <label for="old-string">Old String:</label>
                        <input type="text" id="old-string" placeholder="Tekst za zamijenu">
                    </div>
                    <div class="replacement-input-group">
                        <label for="new-string">New String:</label>
                        <input type="text" id="new-string" placeholder="Novi tekst">
                    </div>
                </div>
            </div>

            <!-- Filtering Panel -->
            <div id="filtering-panel"
                style="padding-right: 15px; background: rgba(49, 82, 118, 0.15); border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <!-- Star Rating Filter -->
                    <div id="star-filter" style="display: flex; gap: 5px;">
                        <button class="star-filter-btn" data-rating="1"
                            style="background: transparent; border: none; font-size: 24px; color: #ddd; cursor: pointer; transition: color 0.2s;">★</button>
                        <button class="star-filter-btn" data-rating="2"
                            style="background: transparent; border: none; font-size: 24px; color: #ddd; cursor: pointer; transition: color 0.2s;">★</button>
                        <button class="star-filter-btn" data-rating="3"
                            style="background: transparent; border: none; font-size: 24px; color: #ddd; cursor: pointer; transition: color 0.2s;">★</button>
                        <button class="star-filter-btn" data-rating="4"
                            style="background: transparent; border: none; font-size: 24px; color: #ddd; cursor: pointer; transition: color 0.2s;">★</button>
                        <button class="star-filter-btn" data-rating="5"
                            style="background: transparent; border: none; font-size: 24px; color: #ddd; cursor: pointer; transition: color 0.2s;">★</button>
                    </div>

                    <!-- Right-aligned checkbox filters -->
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <!-- Kontaktirao Filter -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="kontaktirao-filter"
                                style="width: 18px; height: 18px; cursor: pointer;">
                            <label for="kontaktirao-filter"
                                style="font-weight: bold; color: #ffffff; font-size: 16px; cursor: pointer;">Kontaktirao</label>
                        </div>

                        <!-- Termin Filter -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="termin-filter"
                                style="width: 18px; height: 18px; cursor: pointer;">
                            <label for="termin-filter"
                                style="font-weight: bold; color: #ffffff; font-size: 16px; cursor: pointer;">Ima
                                termin</label>
                        </div>
                    </div>
                </div>
            </div>

            <div id="entries"></div>
        </div>

        <div id="notifications-panel">
            <div style="color: white; margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0; font-size: 20px; color: #ffffff;">📱 Notifikacije</h3>

                <div
                    style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; margin-bottom: 15px;">
                    <div id="ntfy-status"
                        style="color: #ffffff; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                        <span id="ntfy-indicator">📶</span>
                        <span id="ntfy-text">Spajam se...</span>
                    </div>
                </div>

                <div id="notifications-list" style="max-height: 500px; overflow-y: auto;">
                    <div style="color: #ccc; font-style: italic; text-align: center; padding: 20px;">
                        Nema novih notifikacija
                    </div>
                </div>

                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                    <button onclick="clearNotifications()"
                        style="width: 100%; background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">
                        🗑️ Obriši sve
                    </button>
                </div>
            </div>

            <!-- Testing Panel -->
            <div id="testing-panel"
                style="color: white; margin-top: 20px; padding-top: 20px; border-top: 2px solid rgba(255,255,255,0.3); display: none;">
                <h3 style="margin: 0 0 15px 0; font-size: 18px; color: #ffffff;">🧪 Test Notifikacija</h3>

                <!-- Predefined Templates -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #ddd;">Predefined
                        šabloni:</label>
                    <select id="template-select" onchange="loadTemplate()"
                        style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background: white; margin-bottom: 10px;">
                        <option value="">-- Izaberi šablon --</option>
                        <option value="property">Novi Stan</option>
                        <option value="error">Greška</option>
                        <option value="warning">Upozorenje</option>
                        <option value="info">Informacija</option>
                        <option value="custom">HTML Test</option>
                    </select>
                </div>

                <!-- Title Input -->
                <div style="margin-bottom: 10px;">
                    <label style="display: block; margin-bottom: 5px; font-size: 14px; color: #ddd;">Naslov:</label>
                    <input type="text" id="test-title" placeholder="Test naslov..."
                        style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
                </div>

                <!-- Message Input -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-size: 14px; color: #ddd;">Poruka (HTML
                        podržan):</label>
                    <textarea id="test-message" rows="4" placeholder="Test poruka..."
                        style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; resize: vertical; font-family: monospace; font-size: 12px; box-sizing: border-box;"></textarea>
                </div>

                <!-- Type Selection -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-size: 14px; color: #ddd;">Tip:</label>
                    <select id="test-type"
                        style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background: white;">
                        <option value="info">Info (zeleno)</option>
                        <option value="warning">Upozorenje (narandžasto)</option>
                        <option value="error">Greška (crveno)</option>
                    </select>
                </div>

                <!-- Send Button -->
                <button onclick="sendTestNotification()"
                    style="width: 100%; background: #007bff; color: white; border: none; padding: 10px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; margin-bottom: 10px;">
                    🚀 Pošalji Test Notifikaciju
                </button>

                <!-- Send to ntfy.sh Button -->
                <button onclick="sendToNtfy()"
                    style="width: 100%; background: #6f42c1; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; margin-bottom: 10px;">
                    📤 Pošalji na ntfy.sh/stanovi
                </button>

                <!-- Troubleshooting Button -->
                <button onclick="sendSimpleTest()"
                    style="width: 100%; background: #ffc107; color: black; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; margin-bottom: 15px;">
                    🔧 Pošalji Jednostavan Test
                </button>

                <!-- Debug Information -->
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                    <div style="font-size: 12px; color: #ccc; margin-bottom: 10px;">
                        <strong>Debug Info:</strong><br>
                        Topic: stanovi<br>
                        URL: https://ntfy.sh/stanovi<br>
                        Provjeri da li je Android app povezan na isti topic.
                    </div>

                    <button onclick="checkTopicStatus()"
                        style="width: 100%; background: #17a2b8; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        🔍 Provjeri Topic Status
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; cursor: pointer;">
        <div style="position: absolute; top: 20px; right: 30px; color: white; font-size: 34px; cursor: pointer;"
            onclick="closeImageModal()">&times;</div>
        <div
            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 90%; max-height: 90%;">
            <img id="modalImage" style="width: 100%; height: 100%; object-fit: contain;" alt="Property Image">
            <div id="imageCounter"
                style="position: absolute; bottom: -40px; left: 50%; transform: translateX(-50%); color: white; text-align: center;">
            </div>
        </div>
        <div id="prevButton"
            style="position: absolute; top: 50%; left: 30px; transform: translateY(-50%); color: white; font-size: 44px; cursor: pointer; user-select: none;"
            onclick="previousImage()">&#8249;</div>
        <div id="nextButton"
            style="position: absolute; top: 50%; right: 30px; transform: translateY(-50%); color: white; font-size: 44px; cursor: pointer; user-select: none;"
            onclick="nextImage()">&#8250;</div>
    </div>

    <script>
        const entriesDiv = document.getElementById('entries');
        const title = document.getElementById('title');
        const status = document.getElementById('status');

        // JSONBin.io configuration with fallback support
        // Primary bin switches to fallback when >= 90KB (reserves space for comments)
        // The app loads from both bins and merges the results
        const API_KEY = '$2a$10$S0dGVfegNTRBt2VRn91SNOImoGkyfcc8nfF1BtPfbnAXRjAyieFKi';
        const PRIMARY_BIN_ID = '686644268a456b7966ba8958';    // Original bin (full)
        const FALLBACK_BIN_ID = '68b409ebae596e708fdd9573';   // New bin for overflow
        const API_BASE = 'https://api.jsonbin.io/v3/b';

        let entries = [];
        let isLoading = false;
        let isSaving = false;
        let statusTimeout = null;

        // Image modal variables
        let currentImages = [];
        let currentImageIndex = 0;

        // Track new entries added
        let newEntriesCount = 0;
        let newEntryIndices = new Set(); // Track indices of new entries for green border

        function formatDate(dateString) {
            const date = new Date(dateString);
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }

        function getCurrentDateString() {
            return new Date().toISOString();
        }

        function setStatus(message, className = '', autoClear = false) {
            if (statusTimeout) {
                clearTimeout(statusTimeout);
            }

            status.textContent = message;
            status.className = className;

            if (autoClear && message) {
                statusTimeout = setTimeout(() => {
                    status.textContent = '';
                    status.className = '';
                }, 2000);
            }
        }



        async function loadData() {
            if (isLoading) return;
            isLoading = true;
            setStatus('Učitava...', 'loading', false);

            try {
                // Function to load entries from a specific bin
                async function loadFromBin(binId) {
                    const response = await fetch(`${API_BASE}/${binId}`, {
                        method: 'GET',
                        headers: {
                            'X-Master-Key': API_KEY
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.record || [];
                }

                // Load from both bins in parallel
                console.log('Loading entries from both bins...');
                const [primaryResult, fallbackResult] = await Promise.allSettled([
                    loadFromBin(PRIMARY_BIN_ID),
                    loadFromBin(FALLBACK_BIN_ID)
                ]);

                // Combine entries from both bins
                let allEntries = [];

                if (primaryResult.status === 'fulfilled') {
                    allEntries = allEntries.concat(primaryResult.value);
                    console.log(`Loaded ${primaryResult.value.length} entries from primary bin`);
                } else {
                    console.warn('Failed to load from primary bin:', primaryResult.reason);
                }

                if (fallbackResult.status === 'fulfilled') {
                    allEntries = allEntries.concat(fallbackResult.value);
                    console.log(`Loaded ${fallbackResult.value.length} entries from fallback bin`);
                } else {
                    console.warn('Failed to load from fallback bin:', fallbackResult.reason);
                }

                // Remove duplicates based on URL (in case same entry exists in both bins)
                const uniqueEntries = [];
                const seenUrls = new Set();

                for (const entry of allEntries) {
                    if (entry && Object.keys(entry).length > 0 && (entry.url || entry.title)) {
                        if (entry.url && seenUrls.has(entry.url)) {
                            console.log('Skipping duplicate entry:', entry.url);
                            continue;
                        }
                        if (entry.url) {
                            seenUrls.add(entry.url);
                        }
                        uniqueEntries.push(entry);
                    }
                }

                entries = uniqueEntries;

                // Clear new entry tracking on initial load
                newEntryIndices.clear();
                newEntriesCount = 0;

                saveEntriesToDOM();
                updateTitle();

                // Create informative status message
                // Log detailed loading information to console
                const primaryCount = primaryResult.status === 'fulfilled' ? primaryResult.value.length : 0;
                const fallbackCount = fallbackResult.status === 'fulfilled' ? fallbackResult.value.length : 0;
                const duplicatesRemoved = allEntries.length - uniqueEntries.length;

                let consoleMessage = `Učitano ${entries.length} stavki`;
                if (primaryCount > 0 && fallbackCount > 0) {
                    consoleMessage += ` (${primaryCount} + ${fallbackCount} iz 2 baze`;
                    if (duplicatesRemoved > 0) {
                        consoleMessage += `, ${duplicatesRemoved} duplikata uklonjeno`;
                    }
                    consoleMessage += ')';
                } else if (primaryCount > 0) {
                    consoleMessage += ` (glavna baza)`;
                } else if (fallbackCount > 0) {
                    consoleMessage += ` (rezervna baza)`;
                }

                console.log(consoleMessage);
                setStatus('Podaci učitani');
            } catch (error) {
                console.error('Error loading data:', error);
                setStatus('Nije uspjelo, pokusaj opet', 'error');
                entries = []; // Initialize with empty array on error
                saveEntriesToDOM();
                updateTitle();
            } finally {
                isLoading = false;
            }
        }

        async function saveData() {
            if (isSaving) return;
            isSaving = true;
            setStatus('Čuva...', 'loading', false);

            try {
                // If no entries, save [{}] instead of empty array
                const dataToSave = entries.length === 0 ? [{}] : entries;

                const response = await fetch(`${API_BASE}/${PRIMARY_BIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': API_KEY
                    },
                    body: JSON.stringify(dataToSave)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                setStatus('Automatski sačuvano');
            } catch (error) {
                console.error('Error saving data:', error);
                setStatus('Nije uspjelo, pokusaj opet', 'error');
            } finally {
                isSaving = false;
            }
        }



        function toggleComments(headerElement, contentId) {
            const content = document.getElementById(contentId);
            const arrow = headerElement.querySelector('.collapse-arrow');

            if (content.classList.contains('collapsed')) {
                // Expand
                content.classList.remove('collapsed');
                content.style.maxHeight = '220px';
                arrow.classList.remove('collapsed');
                console.log('Expanding comments:', contentId);
            } else {
                // Collapse
                content.classList.add('collapsed');
                content.style.maxHeight = '0';
                arrow.classList.add('collapsed');
                console.log('Collapsing comments:', contentId);
            }
        }

        function updateTitle() {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            const date = `${day}.${month}.${year}`;

            let titleText = `Stanovi ${entries.length > 0 ? date : ''}`;

            // Add count information in the new format
            if (newEntriesCount > 0) {
                titleText += ` (+${newEntriesCount} novih, ${entries.length} total)`;
            } else if (entries.length > 0) {
                titleText += ` (${entries.length} total)`;
            }

            title.textContent = titleText;

            // Update stats info
            updateStatsInfo();
        }

        function updateStatsInfo() {
            const statsDiv = document.getElementById('stats-info');
            if (!statsDiv) return;

            // Only show duplicates info if there are any
            let statsText = '';
            const duplicates = findDuplicates();
            if (duplicates.length > 0) {
                statsText = `Duplikati: ${duplicates.length}`;

                // Create detailed duplicates info
                const duplicatesInfo = duplicates.map(dup =>
                    `• ${dup.identifier} (${dup.count}x)`
                ).join(', ');

                statsText += ` (${duplicatesInfo})`;
            }

            statsDiv.textContent = statsText;
        }

        function findDuplicates() {
            const seen = {};
            const duplicates = [];

            entries.forEach(entry => {
                // Use URL as primary identifier, fall back to title
                let identifier = entry.url || entry.title || 'Unknown';

                // For PDF entries (no URL), use title
                if (!entry.url && entry.title) {
                    identifier = entry.title;
                }

                // Clean up identifier for comparison
                identifier = identifier.trim();

                if (seen[identifier]) {
                    seen[identifier].count++;
                } else {
                    seen[identifier] = {
                        identifier: identifier,
                        count: 1,
                        entries: [entry]
                    };
                }
            });

            // Return only entries that appear more than once
            return Object.values(seen)
                .filter(item => item.count > 1)
                .map(item => ({
                    identifier: item.identifier.length > 50 ?
                        item.identifier.substring(0, 50) + '...' :
                        item.identifier,
                    count: item.count,
                    fullIdentifier: item.identifier
                }));
        }



        function updateEntryModifiedDate(index) {
            entries[index].dateModified = getCurrentDateString();
        }

        function saveEntriesToDOM() {
            entriesDiv.innerHTML = '';
            // Display entries in reverse order (newest first) but keep original indices
            const reversedEntries = [...entries].reverse();
            let lastDisplayedDate = null;

            reversedEntries.forEach((entry, reverseIndex) => {
                const index = entries.length - 1 - reverseIndex; // Get original index
                const wrapper = document.createElement('div');
                wrapper.className = 'entry';
                wrapper.dataset.entryIndex = index;

                // Add ID based on URL hash for anchor functionality
                const urlHash = generateUrlHash(entry.url);
                if (urlHash) {
                    wrapper.id = urlHash;
                }

                // Add green border if this is a new entry
                if (newEntryIndices.has(index)) {
                    wrapper.classList.add('new-entry');
                }

                // Check if this entry has a different date than the previous one
                const entryDate = entry.dateAdded ? formatDate(entry.dateAdded) : null;
                if (entryDate && entryDate !== lastDisplayedDate) {
                    // Create date separator
                    const dateSeparator = document.createElement('div');
                    dateSeparator.className = 'date-separator';
                    dateSeparator.textContent = entryDate;
                    wrapper.appendChild(dateSeparator);
                    lastDisplayedDate = entryDate;
                }

                // Date info
                const dateInfo = document.createElement('div');
                dateInfo.className = 'date-info';
                let dateText = '';
                if (entry.dateAdded) {
                    dateText += `Dodano: ${formatDate(entry.dateAdded)}`;
                }
                if (entry.dateModified && entry.dateModified !== entry.dateAdded) {
                    dateText += ` | Izmijenjeno: ${formatDate(entry.dateModified)}`;
                }
                dateInfo.textContent = dateText;

                // Links row: Separate title area and delete button
                const linksRow = document.createElement('div');
                linksRow.className = 'entry-links-row';
                linksRow.style.cssText = 'display: flex; justify-content: space-between; align-items: flex-start;';

                // Title and email container
                const titleContainer = document.createElement('div');
                titleContainer.style.cssText = 'flex: 1;';

                if (entry.url && entry.url.trim() !== '') {
                    const titleLink = document.createElement('a');
                    titleLink.textContent = entry.title || 'Bez naslova';
                    titleLink.href = applyUrlReplacements(entry.url);
                    titleLink.target = '_blank';
                    titleLink.className = 'entry-title-link';
                    titleContainer.appendChild(titleLink);


                } else {
                    const titleSpan = document.createElement('span');
                    titleSpan.textContent = `PDF: ${entry.title || 'Bez naslova'}`;
                    titleSpan.className = 'entry-title-link';
                    titleSpan.style.cssText = 'font-weight: bold; font-size: 24px; color: #333; text-decoration: none;';
                    titleContainer.appendChild(titleSpan);


                }

                // Add email title if available
                if (entry.emailTitle && entry.emailTitle.trim() !== '') {
                    const emailTitleDiv = document.createElement('div');
                    emailTitleDiv.style.cssText = 'margin-top: 8px; font-size: 16px; color: #666; font-style: italic;';
                    emailTitleDiv.textContent = `Email: ${entry.emailTitle}`;
                    titleContainer.appendChild(emailTitleDiv);
                }

                // Delete button container
                const deleteContainer = document.createElement('div');
                deleteContainer.style.cssText = 'margin-left: 15px;';

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '×';
                deleteBtn.className = 'delete-btn icon-button';
                deleteBtn.onclick = async () => {
                    entries.splice(index, 1);
                    saveEntriesToDOM();
                    updateTitle();
                    // Save changes to remote storage
                    await saveData();
                };
                deleteContainer.appendChild(deleteBtn);

                // Assemble the row
                linksRow.appendChild(titleContainer);
                linksRow.appendChild(deleteContainer);

                // Property Details Section
                const propertyDetails = document.createElement('div');
                propertyDetails.className = 'property-details';
                propertyDetails.style.cssText = 'background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 6px; border: 1px solid #dee2e6;';

                let detailsHTML = '<table style="width: 100%; border-collapse: collapse; font-size: 17px;">';

                // Create address value with navigation links
                let addressValue = entry.address || '';
                if (entry.mapsMene || entry.mapsGrada) {
                    addressValue += '<br/><div style="margin-top: 8px; display: flex; gap: 8px; align-items: center;"><span style="font-weight: bold; color: #333; margin-right: 8px;">Mape:</span>';
                    if (entry.mapsMene) {
                        addressValue += `<a href="${entry.mapsMene}" target="_blank" style="display: inline-block; padding: 6px 12px; background: #007bff; color: white; font-weight: bold; text-decoration: none; border-radius: 4px; font-size: 14px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#0056b3'" onmouseout="this.style.backgroundColor='#007bff'">Adis</a>`;
                    }
                    if (entry.mapsGrada) {
                        addressValue += `<a href="${entry.mapsGrada}" target="_blank" style="display: inline-block; padding: 6px 12px; background: #007bff; color: white; font-weight: bold; text-decoration: none; border-radius: 4px; font-size: 14px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#0056b3'" onmouseout="this.style.backgroundColor='#007bff'">Centar</a>`;
                    }
                    addressValue += '</div>';
                }

                const details = [
                    { key: 'address', label: 'Adresa', value: addressValue },
                    { key: 'flache', label: 'Površina', value: entry.flache },
                    { key: 'zimmer', label: 'Sobe', value: entry.zimmer },
                    { key: 'preis', label: 'Cijena', value: entry.preis },
                    { key: 'monatlicheBelastung', label: 'BK', value: entry.monatlicheBelastung },
                    { key: 'wohnflache', label: 'Površina', value: entry.wohnflache },
                    { key: 'baujahr', label: 'Godina', value: entry.baujahr },
                    { key: 'bauart', label: 'Tip', value: entry.bauart }
                ];

                // Show all columns, even if empty
                const visibleDetails = details;

                if (visibleDetails.length > 0) {
                    // Header row with labels
                    detailsHTML += '<tr style="background: #e9ecef;">';
                    visibleDetails.forEach(detail => {
                        detailsHTML += `<th style="padding: 6px 8px; font-weight: bold; border: 1px solid #dee2e6; text-align: center;">${detail.label}</th>`;
                    });
                    detailsHTML += '</tr>';

                    // Data row with values
                    detailsHTML += '<tr style="background: #ffffff;">';
                    visibleDetails.forEach(detail => {
                        const cellValue = detail.value || ''; // Handle empty/undefined values
                        if (detail.key === 'address') {
                            // Allow HTML for address field (for navigation links)
                            detailsHTML += `<td style="padding: 6px 8px; border: 1px solid #dee2e6; text-align: center;">${cellValue}</td>`;
                        } else {
                            // Escape HTML for other fields
                            detailsHTML += `<td style="padding: 6px 8px; border: 1px solid #dee2e6; text-align: center;">${cellValue}</td>`;
                        }
                    });
                    detailsHTML += '</tr>';
                }

                detailsHTML += '</table>';
                propertyDetails.innerHTML = detailsHTML;

                // Add summary section below the table if summary exists
                if (entry.summary && entry.summary.trim() && entry.summary !== 'Sažetak nije dostupan' && entry.summary !== 'Greška pri generiranju sažetka') {
                    const summaryDiv = document.createElement('div');
                    summaryDiv.style.cssText = 'margin-top: 15px; padding: 10px; background: #f0f8ff; border-left: 4px solid #007bff; border-radius: 4px;';
                    summaryDiv.innerHTML = `<div style="font-weight: bold; margin-bottom: 8px; color: #007bff; font-size: 18px;">Sažetak:</div><div style="font-size: 19px; line-height: 1.4; color: #333;">${entry.summary}</div>`;
                    propertyDetails.appendChild(summaryDiv);
                }

                // Add image gallery if valid images exist
                const validImages = entry.images ? entry.images.filter(image =>
                    image && (image.src || image.thumb) &&
                    image.src !== 'undefined' && image.thumb !== 'undefined' &&
                    image.src !== null && image.thumb !== null &&
                    image.src !== '' && image.thumb !== ''
                ) : [];

                if (validImages.length > 0) {
                    const galleryDiv = document.createElement('div');
                    galleryDiv.style.cssText = 'margin-top: 15px;';

                    // Gallery header
                    const galleryHeader = document.createElement('div');
                    galleryHeader.style.cssText = 'font-weight: bold; margin-bottom: 10px; color: #007bff; font-size: 18px;';
                    galleryHeader.textContent = `Slike (${validImages.length}):`;
                    galleryDiv.appendChild(galleryHeader);

                    // Thumbnail container
                    const thumbnailContainer = document.createElement('div');
                    thumbnailContainer.style.cssText = 'display: flex; gap: 8px; overflow-x: auto; padding: 5px 0; max-width: 100%;';

                    validImages.forEach((image, imgIndex) => {
                        const thumbDiv = document.createElement('div');

                        // Special styling for the special image (first one with isSpecial flag)
                        const isSpecialImage = image.isSpecial === true;
                        const borderColor = isSpecialImage ? '#007bff' : 'transparent';
                        const borderWidth = isSpecialImage ? '3px' : '2px';

                        thumbDiv.style.cssText = `flex-shrink: 0; cursor: pointer; border: ${borderWidth} solid ${borderColor}; border-radius: 4px; transition: border-color 0.2s;`;

                        const thumbImg = document.createElement('img');
                        thumbImg.src = image.thumb || image.src;
                        thumbImg.style.cssText = 'width: 80px; height: 60px; object-fit: cover; border-radius: 4px; display: block;';
                        thumbImg.alt = `Slika ${imgIndex + 1}${isSpecialImage ? ' (Posebna)' : ''}`;

                        // Add hover effect (different for special image)
                        if (isSpecialImage) {
                            thumbDiv.onmouseenter = () => thumbDiv.style.borderColor = '#0056b3'; // Darker blue on hover
                            thumbDiv.onmouseleave = () => thumbDiv.style.borderColor = '#007bff'; // Return to blue
                        } else {
                            thumbDiv.onmouseenter = () => thumbDiv.style.borderColor = '#007bff';
                            thumbDiv.onmouseleave = () => thumbDiv.style.borderColor = 'transparent';
                        }

                        // Add click handler to open modal (use original index in entry.images)
                        const originalIndex = entry.images.indexOf(image);
                        thumbDiv.onclick = () => openImageModal(entry.images, originalIndex, index);

                        thumbDiv.appendChild(thumbImg);
                        thumbnailContainer.appendChild(thumbDiv);
                    });

                    galleryDiv.appendChild(thumbnailContainer);
                    propertyDetails.appendChild(galleryDiv);
                }

                // Adis Box
                const adisBox = document.createElement('div');
                adisBox.className = 'person-box adis';

                const hasAdisComments = (entry.adisNegativno && entry.adisNegativno.trim()) || (entry.adisPozitivno && entry.adisPozitivno.trim());
                const adisCommentStatus = hasAdisComments ? '<strong style="color: #dc3545;">Ima komentar</strong>' : 'Nema komentar';

                adisBox.innerHTML = `
                    <div class="person-header" onclick="toggleComments(this, 'adis-comments-${index}')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="collapse-arrow collapsed" style="font-size: 30px; transition: transform 0.3s ease; color: #888;">▼</span>
                            <span style="font-weight: bold; color: #333; font-size: 18px;">Adis</span>
                            <span style="color: #666; font-size: 16px;">- ${adisCommentStatus}</span>
                        </div>
                        <div class="rating-buttons" style="display: flex; justify-content: flex-end;">
                            ${[1, 2, 3, 4, 5].map(i =>
                    `<button class="rating-btn ${i <= entry.adisOcjena ? 'selected' : ''}" data-rating="${i}" onclick="event.stopPropagation()">★</button>`
                ).join('')}
                        </div>
                    </div>
                    <div id="adis-comments-${index}" class="comment-row collapsible-content collapsed" style="transition: max-height 0.3s ease; overflow: hidden; max-height: 0;">
                        <div class="comment-group">
                            <div class="comment-label">Negativni komentar</div>
                            <textarea class="comment-input" data-entry-index="${index}" data-field="adisNegativno">${entry.adisNegativno || ''}</textarea>
                        </div>
                        <div class="comment-group">
                            <div class="comment-label">Pozitivni komentar</div>
                            <textarea class="comment-input" data-entry-index="${index}" data-field="adisPozitivno">${entry.adisPozitivno || ''}</textarea>
                        </div>
                    </div>
                `;

                // Add event listeners for Adis rating buttons
                const adisRatingButtons = adisBox.querySelectorAll('.rating-buttons .rating-btn');
                adisRatingButtons.forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation(); // Prevent triggering toggle
                        const clickedRating = parseInt(btn.dataset.rating);

                        // Remove all selected classes
                        adisRatingButtons.forEach(b => b.classList.remove('selected'));

                        // Add selected class to all stars up to and including clicked star
                        adisRatingButtons.forEach((b, i) => {
                            if (i + 1 <= clickedRating) {
                                b.classList.add('selected');
                            }
                        });

                        const oldRating = entries[index].adisOcjena;
                        const newRating = clickedRating;
                        entries[index].adisOcjena = newRating;
                        updateEntryModifiedDate(index);
                        // Auto-save when rating changes
                        await saveData();
                        // Send notification only if rating actually changed
                        if (oldRating !== newRating) {
                            await sendCommentRatingNotification(index, 'rating', 'Adis', null, newRating);
                        }
                    });
                });

                // Add event listeners for Adis comment textareas
                const adisCommentTextareas = adisBox.querySelectorAll('textarea[data-field]');
                adisCommentTextareas.forEach(textarea => {
                    let saveTimeout;
                    let notificationTimeout;
                    const originalValue = textarea.value;

                    textarea.addEventListener('input', () => {
                        const field = textarea.dataset.field;
                        const newValue = textarea.value;
                        entries[index][field] = newValue;
                        updateEntryModifiedDate(index);

                        // Debounced auto-save (wait 2 seconds after last change)
                        clearTimeout(saveTimeout);
                        saveTimeout = setTimeout(async () => {
                            await saveData();
                        }, 2000);

                        // Debounced notification (wait 3 seconds after last change)
                        clearTimeout(notificationTimeout);
                        notificationTimeout = setTimeout(async () => {
                            // Only send notification if there's actual content and it changed from original
                            if (newValue.trim() && newValue.trim() !== originalValue.trim()) {
                                await sendCommentRatingNotification(index, 'comment', 'Adis', field);
                            }
                        }, 3000);
                    });
                });

                // Roditelji Box
                const roditeljiBox = document.createElement('div');
                roditeljiBox.className = 'person-box roditelji';

                const hasRoditeljiComments = (entry.roditeljiNegativno && entry.roditeljiNegativno.trim()) || (entry.roditeljiPozitivno && entry.roditeljiPozitivno.trim());
                const roditeljiCommentStatus = hasRoditeljiComments ? '<strong style="color: #dc3545;">Ima komentar</strong>' : 'Nema komentar';

                roditeljiBox.innerHTML = `
                    <div class="person-header" onclick="toggleComments(this, 'roditelji-comments-${index}')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="collapse-arrow collapsed" style="font-size: 30px; transition: transform 0.3s ease; color: #888;">▼</span>
                            <span style="font-weight: bold; color: #333; font-size: 18px;">Camila i Salih</span>
                            <span style="color: #666; font-size: 16px;">- ${roditeljiCommentStatus}</span>
                        </div>
                        <div class="rating-buttons" data-entry-index="${index}" style="display: flex; justify-content: flex-end;">
                            ${[1, 2, 3, 4, 5].map(i =>
                    `<button class="rating-btn ${i <= entry.roditeljiOcjena ? 'selected' : ''}" data-rating="${i}" onclick="event.stopPropagation()">★</button>`
                ).join('')}
                        </div>
                    </div>
                    <div id="roditelji-comments-${index}" class="comment-row collapsible-content collapsed" style="transition: max-height 0.3s ease; overflow: hidden; max-height: 0;">
                        <div class="comment-group">
                            <div class="comment-label">Negativni komentar</div>
                            <textarea class="comment-input" data-entry-index="${index}" data-field="roditeljiNegativno">${entry.roditeljiNegativno || ''}</textarea>
                        </div>
                        <div class="comment-group">
                            <div class="comment-label">Pozitivni komentar</div>
                            <textarea class="comment-input" data-entry-index="${index}" data-field="roditeljiPozitivno">${entry.roditeljiPozitivno || ''}</textarea>
                        </div>
                    </div>
                `;

                // Add event listeners for Roditelji rating buttons
                const ratingButtons = roditeljiBox.querySelectorAll('.rating-buttons .rating-btn');
                ratingButtons.forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation(); // Prevent triggering toggle
                        const clickedRating = parseInt(btn.dataset.rating);

                        // Remove all selected classes
                        ratingButtons.forEach(b => b.classList.remove('selected'));

                        // Add selected class to all stars up to and including clicked star
                        ratingButtons.forEach((b, i) => {
                            if (i + 1 <= clickedRating) {
                                b.classList.add('selected');
                            }
                        });

                        const newRating = clickedRating;
                        entries[index].roditeljiOcjena = newRating;
                        updateEntryModifiedDate(index);
                        // Auto-save when rating changes
                        await saveData();
                        // Send ntfy notification
                        await sendCommentRatingNotification(index, 'rating', 'Roditelji', null, newRating);
                    });
                });

                // Add event listeners for Roditelji comment textareas
                const commentTextareas = roditeljiBox.querySelectorAll('textarea[data-field]');
                commentTextareas.forEach(textarea => {
                    let saveTimeout;
                    let notificationTimeout;
                    textarea.addEventListener('input', () => {
                        const field = textarea.dataset.field;
                        entries[index][field] = textarea.value;
                        updateEntryModifiedDate(index);

                        // Debounced auto-save (wait 2 seconds after last change)
                        clearTimeout(saveTimeout);
                        saveTimeout = setTimeout(async () => {
                            await saveData();
                        }, 2000);

                        // Debounced notification (wait 3 seconds after last change to avoid spam)
                        clearTimeout(notificationTimeout);
                        notificationTimeout = setTimeout(async () => {
                            if (textarea.value.trim()) { // Only send notification if comment is not empty
                                await sendCommentRatingNotification(index, 'comment', 'Roditelji', field);
                            }
                        }, 3000);
                    });
                });

                if (dateText) {
                    wrapper.appendChild(dateInfo);
                }
                wrapper.appendChild(linksRow);
                wrapper.appendChild(propertyDetails);
                wrapper.appendChild(adisBox);
                wrapper.appendChild(roditeljiBox);

                // Add Termin section
                const terminDiv = document.createElement('div');
                terminDiv.className = 'termin';
                terminDiv.style.cssText = 'margin-top: 2px; padding: 2px; display: flex; align-items: center; gap: 15px; justify-content: flex-end;';

                // Checkbox for "Kontaktirao"
                const checkboxContainer = document.createElement('div');
                checkboxContainer.style.cssText = 'display: flex; align-items: center; gap: 5px;';

                const kontaktiraoCheckbox = document.createElement('input');
                kontaktiraoCheckbox.type = 'checkbox';
                kontaktiraoCheckbox.id = `kontaktirao-${index}`;
                kontaktiraoCheckbox.checked = entry.kontaktirao || false;
                kontaktiraoCheckbox.style.cssText = 'margin: 0; width: 18px; height: 18px; cursor: pointer;';

                const kontaktiraoLabel = document.createElement('label');
                kontaktiraoLabel.htmlFor = `kontaktirao-${index}`;
                kontaktiraoLabel.textContent = 'Kontaktirao';
                kontaktiraoLabel.style.cssText = 'font-weight: bold; color: #333; margin: 0; cursor: pointer;';

                checkboxContainer.appendChild(kontaktiraoLabel);
                checkboxContainer.appendChild(kontaktiraoCheckbox);

                // Date input for "Termin"
                const terminContainer = document.createElement('div');
                terminContainer.style.cssText = 'display: flex; align-items: center; gap: 5px;';

                const terminLabel = document.createElement('label');
                terminLabel.htmlFor = `termin-${index}`;
                terminLabel.textContent = 'Termin:';
                terminLabel.style.cssText = 'font-weight: bold; color: #333; margin: 0;';

                const terminInput = document.createElement('input');
                terminInput.type = 'date';
                terminInput.id = `termin-${index}`;
                terminInput.value = entry.termin || '';
                terminInput.style.cssText = 'padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;';

                terminContainer.appendChild(terminLabel);
                terminContainer.appendChild(terminInput);

                terminDiv.appendChild(checkboxContainer);
                terminDiv.appendChild(terminContainer);

                // Add event listeners for notifications
                kontaktiraoCheckbox.addEventListener('change', async () => {
                    const oldValue = entries[index].kontaktirao;
                    const newValue = kontaktiraoCheckbox.checked;
                    entries[index].kontaktirao = newValue;
                    updateEntryModifiedDate(index);
                    await saveData();

                    // Send notification if value changed
                    if (oldValue !== newValue) {
                        const statusText = newValue ? 'kontaktirao agenta' : 'otkazao kontakt sa agentom';
                        await sendContactTerminNotification(index, 'kontaktirao', statusText);
                    }
                });

                terminInput.addEventListener('change', async () => {
                    const oldValue = entries[index].termin;
                    const newValue = terminInput.value;
                    entries[index].termin = newValue;
                    updateEntryModifiedDate(index);
                    await saveData();

                    // Send notification if value changed
                    if (oldValue !== newValue) {
                        const statusText = newValue ? `zakazao termin za ${newValue}` : 'uklonio termin';
                        await sendContactTerminNotification(index, 'termin', statusText);
                    }
                });

                wrapper.appendChild(terminDiv);

                // Add contact information if available
                if (entry.kontaktIme || entry.kontaktTelefon || entry.kontaktEmail || entry.kontaktKompanija) {
                    const contactDiv = document.createElement('div');
                    contactDiv.style.cssText = 'padding: 2px; font-size: 16px; text-align: right;';

                    let contactInfo = '';

                    if (entry.kontaktIme) {
                        contactInfo += `<span style="font-weight: bold; margin-right: 15px;">${entry.kontaktIme}</span>`;
                    }

                    if (entry.kontaktKompanija) {
                        contactInfo += `<span style="color: #666; margin-right: 15px;">${entry.kontaktKompanija}</span>`;
                    }

                    if (entry.kontaktTelefon) {
                        contactInfo += `<a href="tel:${entry.kontaktTelefon}" style="color: #007bff; text-decoration: none; margin-right: 15px;">📞 ${entry.kontaktTelefon}</a>`;
                    }

                    if (entry.kontaktEmail) {
                        contactInfo += `<a href="mailto:${entry.kontaktEmail}" style="color: #007bff; text-decoration: none;">✉️ ${entry.kontaktEmail}</a>`;
                    }

                    contactDiv.innerHTML = contactInfo;
                    wrapper.appendChild(contactDiv);
                }

                entriesDiv.appendChild(wrapper);
            });
        }

        // Handle rating button clicks for Adis
        document.querySelectorAll('#adis-rating .rating-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('#adis-rating .rating-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedAdisRating = btn.dataset.rating;
            };
        });

        // Handle rating button clicks for Roditelji
        document.querySelectorAll('#roditelji-rating .rating-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('#roditelji-rating .rating-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedRoditeljiRating = btn.dataset.rating;
            };
        });



        // Image modal functions
        function openImageModal(images, startIndex, entryIndex) {
            currentImages = images;
            currentImageIndex = startIndex;

            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const imageCounter = document.getElementById('imageCounter');

            modalImage.src = images[startIndex].src;
            imageCounter.textContent = `${startIndex + 1} / ${images.length}`;

            modal.style.display = 'block';
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto'; // Restore scrolling
        }

        function previousImage() {
            if (currentImages.length === 0) return;
            currentImageIndex = (currentImageIndex - 1 + currentImages.length) % currentImages.length;
            updateModalImage();
        }

        function nextImage() {
            if (currentImages.length === 0) return;
            currentImageIndex = (currentImageIndex + 1) % currentImages.length;
            updateModalImage();
        }

        function updateModalImage() {
            const modalImage = document.getElementById('modalImage');
            const imageCounter = document.getElementById('imageCounter');

            modalImage.src = currentImages[currentImageIndex].src;
            imageCounter.textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
        }

        // Keyboard navigation for modal
        document.addEventListener('keydown', function (e) {
            const modal = document.getElementById('imageModal');
            if (modal.style.display === 'block') {
                if (e.key === 'Escape') {
                    closeImageModal();
                } else if (e.key === 'ArrowLeft') {
                    previousImage();
                } else if (e.key === 'ArrowRight') {
                    nextImage();
                }
            }
        });

        // Click outside image to close modal
        document.getElementById('imageModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeImageModal();
            }
        });

        // Update functionality
        async function updateData() {
            if (isLoading) return;

            const updateBtn = document.getElementById('update-btn');
            const originalText = updateBtn.textContent;

            try {
                updateBtn.textContent = 'Učitava...';
                updateBtn.disabled = true;
                setStatus('Dohvaćam najnovije podatke...', 'loading');

                const currentCount = entries.length;

                const response = await fetch(`${API_BASE}/${PRIMARY_BIN_ID}`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': API_KEY
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                let loadedEntries = data.record || [];

                // Filter out empty objects
                loadedEntries = loadedEntries.filter(entry => entry && Object.keys(entry).length > 0 && (entry.url || entry.title));

                // Calculate new entries added
                newEntriesCount = Math.max(0, loadedEntries.length - currentCount);

                // Track indices of new entries for green border styling
                newEntryIndices.clear();
                if (newEntriesCount > 0) {
                    // New entries are at the end of the array (most recent)
                    for (let i = currentCount; i < loadedEntries.length; i++) {
                        newEntryIndices.add(i);
                    }
                }

                entries = loadedEntries;
                saveEntriesToDOM();
                updateTitle();

                if (newEntriesCount > 0) {
                    setStatus(`Učitano ${newEntriesCount} novih unosa`);

                    // Clear green borders after 30 seconds
                    setTimeout(() => {
                        newEntryIndices.clear();
                        saveEntriesToDOM(); // Re-render without green borders
                    }, 30000);
                } else {
                    setStatus('Nema novih unosa');
                }

            } catch (error) {
                console.error('Error updating data:', error);
                setStatus('Nije uspjelo, pokusaj opet', 'error');
            } finally {
                updateBtn.textContent = originalText;
                updateBtn.disabled = false;
            }
        }

        // Update button event listener
        document.getElementById('update-btn').onclick = updateData;

        // Auto-save functionality - no manual save button needed

        // URL Replacement functionality
        let urlReplacements = {};

        // Load replacement mappings from localStorage
        function loadUrlReplacements() {
            const saved = localStorage.getItem('urlReplacements');
            if (saved) {
                urlReplacements = JSON.parse(saved);
            }
        }

        // Save replacement mappings to localStorage
        function saveUrlReplacements() {
            localStorage.setItem('urlReplacements', JSON.stringify(urlReplacements));
        }

        // Apply URL replacements to a URL string
        function applyUrlReplacements(url) {
            let modifiedUrl = url;
            for (const [oldString, newString] of Object.entries(urlReplacements)) {
                if (oldString && newString) {
                    modifiedUrl = modifiedUrl.replace(new RegExp(oldString, 'g'), newString);
                }
            }
            return modifiedUrl;
        }

        // Toggle URL replacement panel
        function toggleUrlReplacementPanel() {
            const panel = document.getElementById('url-replacement-panel');
            panel.classList.toggle('show');

            // Load current values if panel is being shown
            if (panel.classList.contains('show')) {
                loadCurrentReplacementValues();
            }
        }

        // Load current replacement values into inputs
        function loadCurrentReplacementValues() {
            const oldStringInput = document.getElementById('old-string');
            const newStringInput = document.getElementById('new-string');

            // Get the first replacement if any exists
            const entries = Object.entries(urlReplacements);
            if (entries.length > 0) {
                oldStringInput.value = entries[0][0];
                newStringInput.value = entries[0][1];
            }
        }

        // Save replacement on input change
        function saveCurrentReplacement() {
            const oldString = document.getElementById('old-string').value.trim();
            const newString = document.getElementById('new-string').value.trim();

            // Clear all previous replacements and set new one
            urlReplacements = {};
            if (oldString) {
                urlReplacements[oldString] = newString;
            }

            saveUrlReplacements();

            // Re-render entries to apply new replacements
            saveEntriesToDOM();
        }

        // Event listeners for URL replacement
        document.getElementById('title').onclick = toggleUrlReplacementPanel;
        document.getElementById('old-string').onblur = saveCurrentReplacement;
        document.getElementById('new-string').onblur = saveCurrentReplacement;

        // Initialize URL replacements
        loadUrlReplacements();

        // Function to generate hash from URL
        function generateUrlHash(url) {
            if (!url) return null;
            // Simple hash function using the URL
            let hash = 0;
            for (let i = 0; i < url.length; i++) {
                const char = url.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }
            return 'entry-' + Math.abs(hash).toString(16);
        }

        // Function to highlight entry based on URL hash
        function highlightEntryFromHash() {
            const hash = window.location.hash.substring(1); // Remove the #
            if (hash) {
                // Remove existing highlights
                document.querySelectorAll('.entry.highlighted').forEach(el => {
                    el.classList.remove('highlighted');
                });

                // Highlight the target entry
                const targetEntry = document.getElementById(hash);
                if (targetEntry) {
                    targetEntry.classList.add('highlighted');
                    targetEntry.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        // Listen for hash changes
        window.addEventListener('hashchange', highlightEntryFromHash);
        window.addEventListener('load', highlightEntryFromHash);

        // NTFY.SH Notification System
        let ntfyWebSocket = null;
        let ntfyReconnectTimeout = null;
        let ntfyReconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        function updateNtfyStatus(text, connected = false) {
            const indicator = document.getElementById('ntfy-indicator');
            const textElement = document.getElementById('ntfy-text');

            if (textElement) textElement.textContent = text;
            if (indicator) {
                indicator.textContent = connected ? '🟢' : '🔴';
            }
        }

        let notificationHistory = [];

        // Function to convert URLs in text to clickable links
        function makeLinksClickable(text) {
            // Regular expression to match URLs
            const urlRegex = /(https?:\/\/[^\s\n]+)/g;
            return text.replace(urlRegex, '<a href="$1" target="_blank" style="color: #87CEEB; text-decoration: underline;">$1</a>');
        }

        function addToNotificationsList(title, message, type = 'info') {
            const notificationsList = document.getElementById('notifications-list');
            const timestamp = new Date().toLocaleTimeString('hr-HR');

            // Add to history
            notificationHistory.unshift({ title, message, type, timestamp });

            // Clear "no notifications" message
            if (notificationsList.querySelector('div[style*="Nema novih notifikacija"]')) {
                notificationsList.innerHTML = '';
            }

            const notificationItem = document.createElement('div');
            notificationItem.style.cssText = `
                background: rgba(255,255,255,0.1);
                border-radius: 8px;
                padding: 12px;
                margin-bottom: 10px;
                border-left: 4px solid ${type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#4CAF50'};
                position: relative;
            `;

            // Make links clickable in the message
            const processedMessage = makeLinksClickable(message);

            // Create delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '×';
            deleteBtn.style.cssText = `
                position: absolute;
                top: 8px;
                right: 8px;
                background: rgba(255,255,255,0.2);
                border: none;
                border-radius: 50%;
                width: 20px;
                height: 20px;
                color: white;
                font-size: 14px;
                font-weight: bold;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                line-height: 1;
                transition: background-color 0.2s ease;
            `;

            // Add hover effects
            deleteBtn.addEventListener('mouseenter', () => {
                deleteBtn.style.backgroundColor = 'rgba(255,255,255,0.3)';
            });
            deleteBtn.addEventListener('mouseleave', () => {
                deleteBtn.style.backgroundColor = 'rgba(255,255,255,0.2)';
            });

            // Add click handler to delete this notification
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();

                // Remove from DOM with animation
                notificationItem.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                notificationItem.style.opacity = '0';
                notificationItem.style.transform = 'translateX(100%)';

                setTimeout(() => {
                    if (notificationItem.parentNode) {
                        notificationItem.parentNode.removeChild(notificationItem);

                        // Remove from history array
                        const itemIndex = Array.from(notificationsList.children).indexOf(notificationItem);
                        if (itemIndex >= 0 && itemIndex < notificationHistory.length) {
                            notificationHistory.splice(itemIndex, 1);
                        }

                        // Show "no notifications" message if list is empty
                        if (notificationsList.children.length === 0) {
                            notificationsList.innerHTML = `
                                <div style="color: #ccc; font-style: italic; text-align: center; padding: 20px;">
                                    Nema novih notifikacija
                                </div>
                            `;
                        }
                    }
                }, 300);
            });

            notificationItem.innerHTML = `
                <div style="font-weight: bold; font-size: 14px; margin-bottom: 5px; color: white; margin-right: 25px;">${title}</div>
                <div style="font-size: 13px; line-height: 1.4; color: #ddd; white-space: pre-line; margin-right: 25px;">${processedMessage}</div>
                <div style="font-size: 11px; color: #aaa; margin-top: 8px;">${timestamp}</div>
            `;

            // Append delete button after setting innerHTML
            notificationItem.appendChild(deleteBtn);

            notificationsList.insertBefore(notificationItem, notificationsList.firstChild);

            // Limit to 50 notifications
            while (notificationsList.children.length > 50) {
                notificationsList.removeChild(notificationsList.lastChild);
                // Also remove from history
                if (notificationHistory.length > 50) {
                    notificationHistory.splice(50);
                }
            }
        }

        function clearNotifications() {
            const notificationsList = document.getElementById('notifications-list');
            notificationsList.innerHTML = `
                <div style="color: #ccc; font-style: italic; text-align: center; padding: 20px;">
                    Nema novih notifikacija
                </div>
            `;
            notificationHistory = [];
        }

        function showNtfyPopup(title, message, type = 'info') {
            // Add to notifications list
            addToNotificationsList(title, message, type);

            // Remove existing popups
            document.querySelectorAll('.ntfy-popup').forEach(popup => popup.remove());

            const popup = document.createElement('div');
            popup.className = `ntfy-popup ${type}`;

            // Make links clickable in popup message too
            const processedPopupMessage = makeLinksClickable(message);

            popup.innerHTML = `
                <div class="ntfy-close" onclick="this.parentElement.remove()">×</div>
                <div class="ntfy-title">${title}</div>
                <div class="ntfy-message">${processedPopupMessage}</div>
            `;

            document.body.appendChild(popup);

            // Auto-hide after 5 seconds
            setTimeout(() => {
                if (document.body.contains(popup)) {
                    popup.classList.add('hiding');
                    setTimeout(() => popup.remove(), 300);
                }
            }, 5000);

            // Click to dismiss
            popup.addEventListener('click', () => {
                popup.classList.add('hiding');
                setTimeout(() => popup.remove(), 300);
            });
        }

        function connectToNtfy() {
            if (ntfyWebSocket && (ntfyWebSocket.readyState === WebSocket.CONNECTING || ntfyWebSocket.readyState === WebSocket.OPEN)) {
                return;
            }

            updateNtfyStatus('Spajam se...', false);
            console.log('🔔 Connecting to ntfy.sh WebSocket...');

            try {
                // Use Server-Sent Events instead of WebSocket as it's more reliable
                const eventSource = new EventSource('https://ntfy.sh/stanovi/sse');

                eventSource.onopen = function () {
                    console.log('🔔 Connected to ntfy.sh SSE');
                    updateNtfyStatus('Povezan', true);
                    ntfyReconnectAttempts = 0;

                    // Clear any pending reconnect
                    if (ntfyReconnectTimeout) {
                        clearTimeout(ntfyReconnectTimeout);
                        ntfyReconnectTimeout = null;
                    }
                };

                eventSource.onmessage = function (event) {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('🔔 Received notification:', data);

                        // Show popup notification
                        if (data.title && data.message) {
                            showNtfyPopup(data.title, data.message);

                            // Show browser notification if permission granted
                            if (Notification.permission === 'granted') {
                                new Notification(data.title, {
                                    body: data.message,
                                    icon: '🏠'
                                });
                            }
                        }
                    } catch (error) {
                        console.warn('🔔 Failed to parse notification:', error);
                    }
                };

                eventSource.onerror = function (error) {
                    console.error('🔔 ntfy.sh SSE error:', error);
                    updateNtfyStatus('Greška', false);
                    eventSource.close();

                    // Attempt to reconnect
                    if (ntfyReconnectAttempts < maxReconnectAttempts) {
                        ntfyReconnectAttempts++;
                        const delay = Math.min(1000 * Math.pow(2, ntfyReconnectAttempts), 30000);

                        updateNtfyStatus(`Ponovo spajam (${ntfyReconnectAttempts}/${maxReconnectAttempts})...`, false);

                        ntfyReconnectTimeout = setTimeout(() => {
                            connectToNtfy();
                        }, delay);
                    } else {
                        updateNtfyStatus('Neuspješno', false);
                    }
                };

                // Store reference for cleanup
                window.ntfyEventSource = eventSource;

            } catch (error) {
                console.error('🔔 Failed to connect to ntfy.sh:', error);
                updateNtfyStatus('Greška', false);
            }
        }

        // Request notification permission
        if ('Notification' in window) {
            if (Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    console.log('🔔 Notification permission:', permission);
                });
            }
        }

        // Testing Functions
        const templates = {
            property: {
                title: "Novi Stan",
                message: "🏠 Title: Moderni apartman u centru\nAddress: Mariahilfer Str. 123, 1070 Vienna\nPrice: €450,000\n\n🔗 https://htmlpreview.github.io/?https://github.com/HuaMua/stanovi/blob/main/stanovi.html#entry-abc123",
                type: "info"
            },
            error: {
                title: "Greška Sistema",
                message: "❌ Neuspješno povezivanje sa JSONBin API\n\nMolimo pokušajte ponovo za nekoliko minuta.",
                type: "error"
            },
            warning: {
                title: "Upozorenje",
                message: "⚠️ Baza podataka je skoro puna\n\nPreporučuje se arhiviranje starih unosa.",
                type: "warning"
            },
            info: {
                title: "Informacija",
                message: "ℹ️ Sistem je uspješno ažuriran\n\nNove funkcionalnosti su dostupne.",
                type: "info"
            },
            custom: {
                title: "HTML Test",
                message: "<b>Bold text</b>\n<i>Italic text</i>\n<u>Underlined text</u>\n\n<a href='#'>Link test</a>\n\n<span style='color: red;'>Crveni tekst</span>",
                type: "info"
            }
        };

        function loadTemplate() {
            const select = document.getElementById('template-select');
            const template = templates[select.value];

            if (template) {
                document.getElementById('test-title').value = template.title;
                document.getElementById('test-message').value = template.message;
                document.getElementById('test-type').value = template.type;
            }
        }

        function sendTestNotification() {
            const title = document.getElementById('test-title').value || 'Test Naslov';
            const message = document.getElementById('test-message').value || 'Test poruka';
            const type = document.getElementById('test-type').value;

            // Show the notification locally
            showNtfyPopup(title, message, type);

            console.log('🧪 Test notification sent:', { title, message, type });
        }

        async function sendToNtfy() {
            const title = document.getElementById('test-title').value || 'Test Naslov';
            const message = document.getElementById('test-message').value || 'Test poruka';

            try {
                console.log('🚀 Sending to ntfy.sh with:', { title, message });

                const response = await fetch('https://ntfy.sh/stanovi', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain; charset=utf-8',
                        'Title': title,
                        'Tags': 'test,stanovi',
                        'Priority': '4',
                        'Actions': 'view, Otvori stanovi.html, https://htmlpreview.github.io/?https://github.com/HuaMua/stanovi/blob/main/stanovi.html'
                    },
                    body: message
                });

                console.log('📡 Response status:', response.status);
                console.log('📡 Response headers:', [...response.headers.entries()]);

                if (response.ok) {
                    const responseText = await response.text();
                    console.log('📡 Response body:', responseText);
                    showNtfyPopup('✅ Uspješno', 'Poruka je poslana na ntfy.sh/stanovi', 'info');
                    console.log('✅ Message sent to ntfy.sh successfully');
                } else {
                    const errorText = await response.text();
                    console.error('❌ Error response:', errorText);
                    showNtfyPopup('❌ Greška', `Neuspješno slanje: ${response.status}`, 'error');
                    console.error('❌ Failed to send to ntfy.sh:', response.status);
                }
            } catch (error) {
                showNtfyPopup('❌ Greška', 'Neuspješno povezivanje sa ntfy.sh', 'error');
                console.error('❌ Error sending to ntfy.sh:', error);
            }
        }

        async function sendSimpleTest() {
            try {
                console.log('🔧 Sending simple test to ntfy.sh...');

                const response = await fetch('https://ntfy.sh/stanovi', {
                    method: 'POST',
                    body: 'Test poruka sa Android app - ako vidis ovo, sve radi!'
                });

                console.log('📡 Simple test response:', response.status);

                if (response.ok) {
                    showNtfyPopup('✅ Test Poslat', 'Jednostavan test je poslat. Provjeri Android app!', 'info');
                    console.log('✅ Simple test sent successfully');
                } else {
                    showNtfyPopup('❌ Test Neuspješan', `Status: ${response.status}`, 'error');
                }
            } catch (error) {
                showNtfyPopup('❌ Test Error', 'Neuspješno slanje simple test', 'error');
                console.error('❌ Simple test error:', error);
            }
        }

        async function checkTopicStatus() {
            try {
                console.log('🔍 Checking topic status...');

                // Try to fetch the topic page to see if it exists
                const response = await fetch('https://ntfy.sh/stanovi', {
                    method: 'GET'
                });

                console.log('📡 Topic status response:', response.status);

                if (response.ok) {
                    showNtfyPopup('✅ Topic OK', 'Topic "stanovi" postoji na ntfy.sh', 'info');

                    // Send a ping message
                    const pingResponse = await fetch('https://ntfy.sh/stanovi', {
                        method: 'POST',
                        headers: {
                            'Title': 'Ping Test',
                            'Tags': 'ping',
                            'Priority': '1'
                        },
                        body: 'Ping test sa web stranice - ' + new Date().toLocaleTimeString()
                    });

                    if (pingResponse.ok) {
                        console.log('✅ Ping sent successfully');
                    }
                } else {
                    showNtfyPopup('❌ Topic Problem', `Topic response: ${response.status}`, 'error');
                }
            } catch (error) {
                showNtfyPopup('❌ Check Error', 'Neuspješno provjera topic status', 'error');
                console.error('❌ Topic check error:', error);
            }
        }

        // Start ntfy connection when page loads
        setTimeout(connectToNtfy, 1000);

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (window.ntfyEventSource) {
                window.ntfyEventSource.close();
            }
            if (ntfyReconnectTimeout) {
                clearTimeout(ntfyReconnectTimeout);
            }
        });

        // Function to send notification for contact/termin changes
        async function sendContactTerminNotification(entryIndex, changeType, statusText) {
            try {
                const entry = entries[entryIndex];
                if (!entry) return;

                const title = entry.title || 'Property';
                const address = entry.address || 'Unknown address';

                // Generate URL hash for the anchor
                const url = entry.url || '';
                let urlHash = null;
                if (url) {
                    let hash = 0;
                    for (let i = 0; i < url.length; i++) {
                        const char = url.charCodeAt(i);
                        hash = ((hash << 5) - hash) + char;
                        hash = hash & hash; // Convert to 32-bit integer
                    }
                    urlHash = 'entry-' + Math.abs(hash).toString(16);
                }

                const linkUrl = urlHash ?
                    `https://htmlpreview.github.io/?https://github.com/HuaMua/stanovi/blob/main/stanovi.html#${urlHash}` :
                    'https://htmlpreview.github.io/?https://github.com/HuaMua/stanovi/blob/main/stanovi.html';

                // Create notification message
                const notificationTitle = `Kontakt - ${changeType === 'kontaktirao' ? 'Status' : 'Termin'}`;
                const notificationMessage = `📞 ${statusText}\n\n🏠 ${title}\n📍 ${address}\n\n🔗 ${linkUrl}`;

                // Send notification
                fetch('https://ntfy.sh/stanovi', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain; charset=utf-8',
                        'Title': notificationTitle,
                        'Tags': 'contact,termin',
                        'Priority': '3',
                        'Actions': 'view, Otvori stan, ' + linkUrl
                    },
                    body: notificationMessage
                }).then(response => {
                    if (response.ok) {
                        console.log('📤 Contact/Termin notification sent successfully');
                    } else {
                        console.warn('⚠️ Failed to send contact/termin notification:', response.status);
                    }
                }).catch(error => {
                    console.warn('⚠️ Failed to send contact/termin notification:', error);
                });
            } catch (error) {
                console.warn('Failed to send contact/termin notification:', error);
            }
        }

        // Function to send notification for comment/rating changes
        async function sendCommentRatingNotification(entryIndex, changeType, person, field = null, value = null) {
            try {
                const entry = entries[entryIndex];
                if (!entry) return;

                const title = entry.title || 'Property';
                const address = entry.address || 'Unknown address';

                // Generate URL hash for the anchor
                const url = entry.url || '';
                let urlHash = null;
                if (url) {
                    let hash = 0;
                    for (let i = 0; i < url.length; i++) {
                        const char = url.charCodeAt(i);
                        hash = ((hash << 5) - hash) + char;
                        hash = hash & hash; // Convert to 32-bit integer
                    }
                    urlHash = 'entry-' + Math.abs(hash).toString(16);
                }

                const linkUrl = urlHash ?
                    `https://htmlpreview.github.io/?https://github.com/HuaMua/stanovi/blob/main/stanovi.html#${urlHash}` :
                    'https://htmlpreview.github.io/?https://github.com/HuaMua/stanovi/blob/main/stanovi.html';

                // Create notification message based on change type
                let notificationMessage = '';
                let notificationTitle = '';

                if (changeType === 'rating') {
                    notificationTitle = `${person} - Ocjena`;
                    notificationMessage = `⭐ ${person} je ocjenio stan sa ${value}/5\n\n🏠 ${title}\n📍 ${address}\n\n🔗 ${linkUrl}`;
                } else if (changeType === 'comment') {
                    const commentType = field === 'adisNegativno' || field === 'roditeljiNegativno' ? 'negativni' : 'pozitivni';
                    notificationTitle = `${person} - Komentar`;
                    notificationMessage = `💬 ${person} je dodao ${commentType} komentar\n\n🏠 ${title}\n📍 ${address}\n\n🔗 ${linkUrl}`;
                }

                // Send notification
                fetch('https://ntfy.sh/stanovi', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain; charset=utf-8',
                        'Title': notificationTitle,
                        'Tags': 'comment,rating',
                        'Priority': '3',
                        'Actions': 'view, Otvori stan, ' + linkUrl
                    },
                    body: notificationMessage
                }).then(response => {
                    if (response.ok) {
                        console.log('✅ Comment/rating notification sent to ntfy.sh/stanovi');
                    } else {
                        console.warn('⚠️ Failed to send comment/rating notification:', response.status);
                    }
                }).catch(error => {
                    console.warn('⚠️ Failed to send comment/rating notification:', error);
                });
            } catch (error) {
                console.warn('Failed to send comment/rating notification:', error);
            }
        }

        // Check URL parameter and show testing panel if needed
        function checkTestingParameter() {
            const urlParams = new URLSearchParams(window.location.search);
            const testingParam = urlParams.get('testing');

            if (testingParam === 'true') {
                const testingPanel = document.getElementById('testing-panel');
                if (testingPanel) {
                    testingPanel.style.display = 'block';
                    console.log('🧪 Testing panel enabled via URL parameter');
                }
            }
        }

        // Filter state
        let activeFilters = {
            starRating: null,
            kontaktirao: false,
            termin: false
        };

        // Filter functionality
        function setupFilters() {
            // Star rating filter
            const starFilterButtons = document.querySelectorAll('.star-filter-btn');
            starFilterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const rating = parseInt(btn.dataset.rating);

                    if (activeFilters.starRating === rating) {
                        // Reset if clicking the same star
                        activeFilters.starRating = null;
                        updateStarFilterDisplay();
                    } else {
                        // Set new rating filter
                        activeFilters.starRating = rating;
                        updateStarFilterDisplay();
                    }

                    applyFilters();
                });

                // Add hover effects
                btn.addEventListener('mouseenter', () => {
                    const hoverRating = parseInt(btn.dataset.rating);
                    updateStarFilterDisplay(hoverRating);
                });

                btn.addEventListener('mouseleave', () => {
                    updateStarFilterDisplay();
                });
            });

            // Kontaktirao filter
            const kontaktiraoFilter = document.getElementById('kontaktirao-filter');
            kontaktiraoFilter.addEventListener('change', () => {
                activeFilters.kontaktirao = kontaktiraoFilter.checked;
                applyFilters();
            });

            // Termin filter
            const terminFilter = document.getElementById('termin-filter');
            terminFilter.addEventListener('change', () => {
                activeFilters.termin = terminFilter.checked;
                applyFilters();
            });


        }

        function updateStarFilterDisplay(hoverRating = null) {
            const starFilterButtons = document.querySelectorAll('.star-filter-btn');
            starFilterButtons.forEach((btn, index) => {
                const btnRating = parseInt(btn.dataset.rating);

                // Determine which rating to display (hover takes precedence)
                const displayRating = hoverRating || activeFilters.starRating;

                if (displayRating && btnRating <= displayRating) {
                    if (hoverRating && btnRating <= hoverRating) {
                        // Hover preview - slightly different color
                        btn.style.color = '#ffeb3b'; // Lighter gold for hover preview
                    } else if (activeFilters.starRating && btnRating <= activeFilters.starRating) {
                        // Active filter - normal gold
                        btn.style.color = '#ffc107'; // Gold color for active stars
                    } else {
                        btn.style.color = '#ddd'; // Gray for inactive stars
                    }
                } else {
                    btn.style.color = '#ddd'; // Gray for inactive stars
                }
            });
        }

        function applyFilters() {
            const entriesDiv = document.getElementById('entries');
            const allEntries = entriesDiv.querySelectorAll('.entry');
            let visibleCount = 0;

            allEntries.forEach((entryDiv) => {
                const entryIndex = parseInt(entryDiv.dataset.entryIndex);
                const entry = entries[entryIndex];
                let shouldShow = true;

                if (!entry) {
                    console.warn(`Entry not found for index ${entryIndex}`);
                    entryDiv.style.display = 'none';
                    return;
                }

                // Star rating filter
                if (activeFilters.starRating !== null) {
                    const adisRating = parseInt(entry.adisOcjena) || 0;
                    const roditeljiRating = parseInt(entry.roditeljiOcjena) || 0;
                    const maxRating = Math.max(adisRating, roditeljiRating);

                    if (maxRating < activeFilters.starRating) {
                        shouldShow = false;
                    }
                }

                // Kontaktirao filter
                if (activeFilters.kontaktirao && !entry.kontaktirao) {
                    shouldShow = false;
                }

                // Termin filter
                if (activeFilters.termin && (!entry.termin || entry.termin.trim() === '')) {
                    shouldShow = false;
                }

                // Show/hide entry
                entryDiv.style.display = shouldShow ? 'block' : 'none';
                if (shouldShow) visibleCount++;
            });

            // Debug information
            console.log(`Filter applied: ${visibleCount} entries visible out of ${entries.length}`);
            if (activeFilters.kontaktirao) {
                const kontaktiraoEntries = entries.filter(e => e.kontaktirao);
                console.log(`Kontaktirao filter active: ${kontaktiraoEntries.length} entries have kontaktirao=true`);
                kontaktiraoEntries.forEach((entry, i) => {
                    console.log(`Entry ${i}: kontaktirao=${entry.kontaktirao}, title="${entry.title}"`);
                });
            }
        }

        // Load data on page load
        loadData();

        // Check testing parameter
        checkTestingParameter();

        // Setup filters after a delay to ensure DOM is ready
        setTimeout(setupFilters, 100);
    </script>
</body>

</html>
