<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Stanovi</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            position: relative;
            z-index: 1;
            min-height: 100vh;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url(https://cdn.pixabay.com/photo/2020/04/21/18/49/tropical-5074304_960_720.jpg) no-repeat center center fixed;
            background-size: cover;
            opacity: 0.3;
            z-index: -1;
        }

        #sidebar {
            width: 60%;
            margin: 0 auto;
            overflow-y: auto;
            background: #ffffff6b;
            padding: 20px;
            box-sizing: border-box;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-top: 40px;
        }

        #add-entry,
        #delete-btn {
            margin-left: 10px;
        }

        .entry {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 15px;
        }

        .entry-row {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            align-items: center;
        }

        .entry-row input[type="text"] {
            flex: 1;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .rating-buttons {
            display: flex;
            gap: 5px;
        }

        .rating-btn {
            width: 30px;
            height: 30px;
            padding: 0;
            font-size: 14px;
            font-weight: bold;
            background: #cfcfcf;
            color: #333;
        }

        .rating-btn.selected {
            background: #007BFF;
            color: white;
        }

        .rating-btn.selected:hover {
            background: #0056b3;
        }

        .entry-row a {
            color: #007BFF;
            text-decoration: none;
            word-break: break-all;
            margin-right: 10px;
        }

        .entry-title-link {
            color: #007BFF;
            text-decoration: none;
            font-weight: bold;
            flex: 1;
            font-size: 14px;
            text-decoration: underline;
        }

        .entry-title-link:hover {
            text-decoration: underline;
        }

        textarea {
            width: 98%;
            resize: vertical;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: Arial, sans-serif;
            height: 70px;
        }

        button {
            background: #e5e5e5;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin: 2px;
        }

        button:hover {
            background: #9f9f9f;
        }

        #save-btn {
            background: #007BFF;
        }

        #save-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .saving {
            background: #ffc107 !important;
        }

        h2 {
            margin: 0;
            display: inline-block;
            vertical-align: middle;
            color: #356e91;
        }

        .header-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 40px;
            margin-bottom: 20px;
        }

        .header-left {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-right {
            display: flex;
            gap: 10px;
        }

        #new-entry {
            border-bottom: 3px solid #c3c4c5;
            margin-bottom: 20px;
            padding-bottom: 15px;
        }

        .collapse-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f0f0f0;
            padding: 10px 15px;
            margin: -10px -10px 15px -10px;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            border-bottom: 1px solid #ddd;
        }

        .collapse-header h3 {
            margin: 0;
            color: #356e91;
            font-size: 16px;
        }

        .collapse-arrow {
            transition: transform 0.3s ease;
            font-size: 18px;
        }

        .collapse-arrow.collapsed {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.collapsed {
            max-height: 0;
        }

        .person-box {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            margin-top: 12px;
            background: #f8f9fa;
        }

        .person-box.adis {
            background: #f4fff7;
        }

        .person-box.roditelji {
            background: #d2e6f5;
        }

        .person-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .comment-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .comment-group {
            flex: 1;
        }

        .comment-label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
            font-size: 12px;
        }

        .comment-input {
            width: 95%;
            height: 60px;
            resize: vertical;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: Arial, sans-serif;
            font-size: 14px;
        }

        .comment-display {
            width: 95%;
            min-height: 60px;
            padding: 6px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            color: #555;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .person-box.adis .comment-display {
            background-color: #edfff2;
        }

        .icon-button {
            font-size: 18px;
        }

        .paste-data-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 8px;
        }

        .paste-data-row textarea {
            flex: 1;
            height: 40px;
            font-family: monospace;
            font-size: 12px;
        }

        .url-search-save-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 8px;
        }

        .url-search-save-row input {
            flex: 1;
        }

        .maps-row {
            display: flex;
            gap: 10px;
        }

        .maps-row input {
            flex: 1;
        }

        .entry-links-row {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            align-items: center;
        }

        .instruction-text {
            font-size: 11px;
            color: #666;
            margin-bottom: 5px;
            font-style: italic;
        }

        .date-info {
            font-size: 11px;
            color: #666;
            margin-bottom: 8px;
            font-style: italic;
        }

        #status {
            font-size: 19px;
            color: #007bff;
            padding: 7px;
            font-style: italic;
        }

        .loading {
            color: #666;
            font-style: italic;
        }

        .error {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div id="sidebar">
        <div class="header-buttons">
            <div class="header-left">
                <h2 id="title">Stanovi</h2>
            </div>
            <div class="header-right">
                <span id="status" class="loading">Loading...</span>
                <button id="save-btn">Save</button>
            </div>
        </div>
        <div id="new-entry">
            <div class="entry">
                <div class="collapse-header" onclick="toggleNewEntry()">
                    <h3>Dodaj novi stan</h3>
                    <span class="collapse-arrow collapsed">‚ñº</span>
                </div>
                <div class="collapsible-content collapsed" id="new-entry-content">
                    <div class="paste-data-row">
                        <textarea id="paste-data" placeholder='Paste JSON data here'></textarea>
                        <button id="search-btn" class="icon-button" title="Parse pasted data">üîç</button>
                    </div>
                    <div class="url-search-save-row">
                        <input type="text" id="new-url" placeholder="URL">
                        <button id="add-entry" class="icon-button">üíæ</button>
                    </div>
                    <div class="entry-row">
                        <input type="text" id="new-title" placeholder="Title">
                    </div>
                    <div class="maps-row">
                        <input type="text" id="new-maps-mene" placeholder="Do mene (Google Maps)">
                        <input type="text" id="new-maps-grada" placeholder="Do grada (Google Maps)">
                    </div>

                    <!-- Adis Box -->
                    <div class="person-box adis">
                        <div class="person-header">
                            <div class="rating-buttons" id="adis-rating">
                                <button class="rating-btn" data-rating="1">1</button>
                                <button class="rating-btn" data-rating="2">2</button>
                                <button class="rating-btn" data-rating="3">3</button>
                                <button class="rating-btn" data-rating="4">4</button>
                                <button class="rating-btn" data-rating="5">5</button>
                            </div>
                        </div>
                        <div class="comment-row">
                            <div class="comment-group">
                                <div class="comment-label">Negativni komentar</div>
                                <textarea id="adis-negativno" class="comment-input"></textarea>
                            </div>
                            <div class="comment-group">
                                <div class="comment-label">Pozitivni komentar</div>
                                <textarea id="adis-pozitivno" class="comment-input"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="entries"></div>
    </div>

    <script>
        const entriesDiv = document.getElementById('entries');
        const title = document.getElementById('title');
        const status = document.getElementById('status');
        const saveBtn = document.getElementById('save-btn');

        // JSONBin.io configuration
        const API_KEY = '$2a$10$S0dGVfegNTRBt2VRn91SNOImoGkyfcc8nfF1BtPfbnAXRjAyieFKi';
        const BIN_ID = '686644268a456b7966ba8958';
        const API_BASE = 'https://api.jsonbin.io/v3/b';

        let entries = [];
        let selectedAdisRating = null;
        let isLoading = false;
        let isSaving = false;
        let statusTimeout = null;

        function formatDate(dateString) {
            const date = new Date(dateString);
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${month}.${day}`;
        }

        function getCurrentDateString() {
            return new Date().toISOString();
        }

        function setStatus(message, className = '', autoClear = true) {
            if (statusTimeout) {
                clearTimeout(statusTimeout);
            }

            status.textContent = message;
            status.className = className;

            if (autoClear && message) {
                statusTimeout = setTimeout(() => {
                    status.textContent = '';
                    status.className = '';
                }, 2000);
            }
        }

        async function loadData() {
            if (isLoading) return;
            isLoading = true;
            setStatus('Loading...', 'loading', false);

            try {
                const response = await fetch(`${API_BASE}/${BIN_ID}`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': API_KEY
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                let loadedEntries = data.record || [];

                // Filter out empty objects (like {})
                entries = loadedEntries.filter(entry => {
                    return entry && Object.keys(entry).length > 0 && entry.url;
                });

                saveEntriesToDOM();
                updateTitle();
                setStatus('Data loaded successfully');
            } catch (error) {
                console.error('Error loading data:', error);
                setStatus('Error loading data', 'error');
                entries = []; // Initialize with empty array on error
                saveEntriesToDOM();
                updateTitle();
            } finally {
                isLoading = false;
            }
        }

        async function saveData() {
            if (isSaving) return;
            isSaving = true;
            saveBtn.disabled = true;
            saveBtn.className = 'saving';
            saveBtn.textContent = 'Saving...';

            try {
                // If no entries, save [{}] instead of empty array
                const dataToSave = entries.length === 0 ? [{}] : entries;

                const response = await fetch(`${API_BASE}/${BIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': API_KEY
                    },
                    body: JSON.stringify(dataToSave)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                setStatus('Data saved successfully');
            } catch (error) {
                console.error('Error saving data:', error);
                setStatus('Error saving data', 'error');
            } finally {
                isSaving = false;
                saveBtn.disabled = false;
                saveBtn.className = '';
                saveBtn.textContent = 'Save';
            }
        }

        function toggleNewEntry() {
            const content = document.getElementById('new-entry-content');
            const arrow = document.querySelector('.collapse-arrow');

            content.classList.toggle('collapsed');
            arrow.classList.toggle('collapsed');
        }

        function updateTitle() {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            const date = `${day}.${month}.${year}`;
            title.textContent = `Stanovi ${entries.length > 0 ? date : ''}`;
        }

        function parseScrapedData() {
            const pasteData = document.getElementById('paste-data').value.trim();

            if (!pasteData) {
                alert('Please paste the JSON data from the scraper script first.');
                return;
            }

            try {
                const data = JSON.parse(pasteData);

                // Validate that we have the expected fields
                if (!data.url) {
                    alert('Invalid data: missing URL field');
                    return;
                }

                // Populate the form fields
                if (data.url) {
                    document.getElementById('new-url').value = data.url;
                }
                if (data.title) {
                    document.getElementById('new-title').value = data.title;
                }
                if (data.mapsMene) {
                    document.getElementById('new-maps-mene').value = data.mapsMene;
                }
                if (data.mapsGrada) {
                    document.getElementById('new-maps-grada').value = data.mapsGrada;
                }

                // Clear the paste area after successful parsing
                document.getElementById('paste-data').value = '';
            } catch (error) {
                console.error('Error parsing JSON:', error);
                alert('‚ùå Error parsing JSON data. Please make sure you copied the correct data from the scraper script.\n\nExpected format: {"url":"...","title":"...","mapsMene":"...","mapsGrada":"..."}');
            }
        }

        function updateEntryModifiedDate(index) {
            entries[index].dateModified = getCurrentDateString();
        }

        function saveEntriesToDOM() {
            entriesDiv.innerHTML = '';
            entries.forEach((entry, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'entry';

                // Date info
                const dateInfo = document.createElement('div');
                dateInfo.className = 'date-info';
                let dateText = '';
                if (entry.dateAdded) {
                    dateText += `Added: ${formatDate(entry.dateAdded)}`;
                }
                if (entry.dateModified && entry.dateModified !== entry.dateAdded) {
                    dateText += ` | Modified: ${formatDate(entry.dateModified)}`;
                }
                dateInfo.textContent = dateText;

                // Links row: Do mene, Do grada, then Title
                const linksRow = document.createElement('div');
                linksRow.className = 'entry-links-row';

                if (entry.mapsMene) {
                    const meneLink = document.createElement('a');
                    meneLink.textContent = 'Do mene';
                    meneLink.href = entry.mapsMene;
                    meneLink.target = '_blank';
                    meneLink.style.color = '#28a745';
                    meneLink.style.fontWeight = 'bold';
                    linksRow.appendChild(meneLink);
                }

                if (entry.mapsGrada) {
                    const gradaLink = document.createElement('a');
                    gradaLink.textContent = 'Do grada';
                    gradaLink.href = entry.mapsGrada;
                    gradaLink.target = '_blank';
                    gradaLink.style.color = '#28a745';
                    gradaLink.style.fontWeight = 'bold';
                    linksRow.appendChild(gradaLink);
                }

                const titleLink = document.createElement('a');
                titleLink.textContent = entry.title || 'No Title';
                titleLink.href = entry.url;
                titleLink.target = '_blank';
                titleLink.className = 'entry-title-link';
                linksRow.appendChild(titleLink);

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = 'üóëÔ∏è';
                deleteBtn.className = 'delete-btn icon-button';
                deleteBtn.onclick = () => {
                    entries.splice(index, 1);
                    saveEntriesToDOM();
                    updateTitle();
                };
                linksRow.appendChild(deleteBtn);

                // Adis Box
                const adisBox = document.createElement('div');
                adisBox.className = 'person-box adis';
                adisBox.innerHTML = `
                    <div class="person-header">
                        <div class="rating-buttons">
                            ${[1, 2, 3, 4, 5].map(i =>
                    `<button class="rating-btn ${i == entry.adisOcjena ? 'selected' : ''}" disabled>${i}</button>`
                ).join('')}
                        </div>
                    </div>
                    <div class="comment-row">
                        <div class="comment-group">
                            <div class="comment-label">Negativni komentar</div>
                            <div class="comment-display">${entry.adisNegativno || ''}</div>
                        </div>
                        <div class="comment-group">
                            <div class="comment-label">Pozitivni komentar</div>
                            <div class="comment-display">${entry.adisPozitivno || ''}</div>
                        </div>
                    </div>
                `;

                // Roditelji Box
                const roditeljiBox = document.createElement('div');
                roditeljiBox.className = 'person-box roditelji';
                roditeljiBox.innerHTML = `
                    <div class="person-header">
                        <div class="rating-buttons" data-entry-index="${index}">
                            ${[1, 2, 3, 4, 5].map(i =>
                    `<button class="rating-btn ${i == entry.roditeljiOcjena ? 'selected' : ''}" data-rating="${i}">${i}</button>`
                ).join('')}
                        </div>
                    </div>
                    <div class="comment-row">
                        <div class="comment-group">
                            <div class="comment-label">Negativni komentar</div>
                            <textarea class="comment-input" data-entry-index="${index}" data-field="roditeljiNegativno">${entry.roditeljiNegativno || ''}</textarea>
                        </div>
                        <div class="comment-group">
                            <div class="comment-label">Pozitivni komentar</div>
                            <textarea class="comment-input" data-entry-index="${index}" data-field="roditeljiPozitivno">${entry.roditeljiPozitivno || ''}</textarea>
                        </div>
                    </div>
                `;

                // Add event listeners for Roditelji rating buttons
                const ratingButtons = roditeljiBox.querySelectorAll('.rating-buttons .rating-btn');
                ratingButtons.forEach(btn => {
                    btn.onclick = () => {
                        ratingButtons.forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                        entries[index].roditeljiOcjena = btn.dataset.rating;
                        updateEntryModifiedDate(index);
                    };
                });

                // Add event listeners for Roditelji comment textareas
                const commentTextareas = roditeljiBox.querySelectorAll('textarea[data-field]');
                commentTextareas.forEach(textarea => {
                    textarea.addEventListener('input', () => {
                        const field = textarea.dataset.field;
                        entries[index][field] = textarea.value;
                        updateEntryModifiedDate(index);
                    });
                });

                if (dateText) {
                    wrapper.appendChild(dateInfo);
                }
                wrapper.appendChild(linksRow);
                wrapper.appendChild(adisBox);
                wrapper.appendChild(roditeljiBox);
                entriesDiv.appendChild(wrapper);
            });
        }

        // Handle rating button clicks for Adis
        document.querySelectorAll('#adis-rating .rating-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('#adis-rating .rating-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedAdisRating = btn.dataset.rating;
            };
        });

        // Handle rating button clicks for Roditelji
        document.querySelectorAll('#roditelji-rating .rating-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('#roditelji-rating .rating-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedRoditeljiRating = btn.dataset.rating;
            };
        });

        // Parse button functionality (search icon)
        document.getElementById('search-btn').onclick = parseScrapedData;

        document.getElementById('add-entry').onclick = () => {
            const title = document.getElementById('new-title').value;
            const url = document.getElementById('new-url').value;
            const mapsMene = document.getElementById('new-maps-mene').value;
            const mapsGrada = document.getElementById('new-maps-grada').value;
            const adisNegativno = document.getElementById('adis-negativno').value;
            const adisPozitivno = document.getElementById('adis-pozitivno').value;

            if (!url || !selectedAdisRating) return;

            const currentDate = getCurrentDateString();
            entries.push({
                title,
                url,
                mapsMene,
                mapsGrada,
                adisNegativno,
                adisPozitivno,
                adisOcjena: selectedAdisRating,
                dateAdded: currentDate,
                dateModified: currentDate,
                // Default values for Roditelji
                roditeljiNegativno: '',
                roditeljiPozitivno: '',
                roditeljiOcjena: null
            });

            // Clear form
            document.getElementById('new-title').value = '';
            document.getElementById('new-url').value = '';
            document.getElementById('new-maps-mene').value = '';
            document.getElementById('new-maps-grada').value = '';
            document.getElementById('adis-negativno').value = '';
            document.getElementById('adis-pozitivno').value = '';
            document.getElementById('paste-data').value = '';
            document.querySelectorAll('#adis-rating .rating-btn').forEach(b => b.classList.remove('selected'));
            selectedAdisRating = null;

            saveEntriesToDOM();
            updateTitle();
        };

        document.getElementById('save-btn').onclick = saveData;

        // Load data on page load
        loadData();
    </script>
</body>

</html>
